import numpy as np
import pandas as pd
import os
import gc
import warnings;
warnings.filterwarnings('ignore')

#d1 = pd.read_csv("../ketqua/data/DatatrainTEST.csv") #DatatrainTEST
#d1 = pd.read_csv("../ketqua/data/DataTrainLabels1.csv").append(pd.read_csv("../ketqua/data/DataTrainLabels2.csv")).append(pd.read_csv("../ketqua/data/DataTrainLabels3.csv")).append(pd.read_csv("../ketqua/data/DataTrainLabels4.csv"))
d1 = pd.read_csv("../ketqua/dataF/DataTrainLabels1.csv").append(pd.read_csv("../ketqua/dataF/DataTrainLabels2.csv")).append(pd.read_csv("../ketqua/dataF/DataTrainLabels3.csv")).append(pd.read_csv("../ketqua/dataF/DataTrainLabels4.csv"))

print(d1.shape);

gc.collect();
from sklearn.model_selection import train_test_split
X_train, X_test, Y_train, Y_test = train_test_split( (d1.iloc[:,0:65536]) , (d1['Class'] - 1) , test_size=0.1)
X_train, X_val, Y_train, Y_val = train_test_split(X_train, Y_train, test_size = (0.1/0.9) )

del d1
gc.collect();

num_classes = len(np.unique(Y_train))   # số nhãn của tập DL
labels = np.unique(Y_train)     # nhãn duy nhất

from sklearn import svm
# Initialize SVM classifier
clf = svm.SVC(kernel='linear', probability=True)
clf = clf.fit(X_train, Y_train)

# save the model
from joblib import dump, load
dump(clf, '../ketqua/SVM/model_SVM')

y_pred = clf.predict(X_test)

# Accuracy: (tp + tn) / (p + n)
from sklearn.metrics import accuracy_score
accuracy = accuracy_score(Y_test, y_pred)

print('Accuracy: %.4f' % accuracy)

print("--------------- [The end] ------------------")


#print(y_pred)
nhan = ['Ramnit', 'Lollipop', 'Kelihos_ver3', 'Vundo', 'Simda', 'Tracur', 'Kelihos_ver1' , 'Obfuscator.ACY', 'Gatak']

from sklearn.metrics import classification_report, confusion_matrix
from sklearn.metrics import ConfusionMatrixDisplay
from matplotlib import pyplot as plt

print(classification_report(Y_test,y_pred))

Cmatrix = confusion_matrix(Y_test, y_pred, normalize='true')
cmd = ConfusionMatrixDisplay(Cmatrix, display_labels=nhan)
cmd.plot(cmap='Blues', xticks_rotation='vertical')
plt.savefig('../ketqua/SVM/model_SVM_CM.png')  




